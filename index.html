<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Make a Wish - 吹蠟燭小遊戲</title>
<style>
  :root{
    --w: 800px; /* 基準畫布寬 */
    --h: 600px; /* 基準畫布高 */
  }
  *{ box-sizing: border-box; }
  body{
    margin:0; background:#111; color:#fff; font-family: ui-sans-serif, -apple-system, "Noto Sans TC", Arial;
    display:flex; align-items:center; justify-content:center; min-height:100dvh;
  }
  .game-wrap{
    width:min(95vw, var(--w));
    aspect-ratio: 4/3;
    position:relative;
    user-select:none;
    -webkit-user-select:none;
    overflow:hidden;
    border-radius:16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06);
    background:#000;
  }
  .stage{
    position:absolute; inset:0;
    background: center/cover no-repeat url("./cake.png");
  }

  /* UI */
  .hud{
    position:absolute; left:0; right:0; top:0;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; gap:10px;
    background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
    font-weight:700;
  }
  .badge{
    background: rgba(0,0,0,.5);
    padding:6px 10px; border-radius:999px; font-size:14px;
  }
  .hearts{
    display:flex; gap:6px; align-items:center;
  }
  .heart{
    width:18px; height:18px; display:inline-block;
    background: currentColor; color:#ff5166;
    clip-path: path("M12 21s-7.5-4.35-9.6-8.4C.6 9.1 2.1 6 5.1 6c1.6 0 3 .9 3.9 2.1C9.9 6.9 11.3 6 12.9 6c3 0 4.5 3.1 2.7 6.6C19.5 16.65 12 21 12 21z");
    transform: scale(.9);
  }
  .heart.lost{ color:#444; }

  /* 按鈕層 */
  .overlay{
    position:absolute; inset:0; display:grid; place-items:center;
    background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,.75));
  }
  .panel{
    text-align:center; padding:24px 22px; border-radius:14px;
    background: rgba(18,18,18,.75);
    box-shadow: 0 6px 24px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,255,255,.06);
    backdrop-filter: blur(4px);
  }
  .title{ font-size:24px; margin:0 0 8px; }
  .subtitle{ opacity:.8; margin:0 0 16px; font-size:14px; }
  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:800; letter-spacing:.4px;
    padding:12px 18px; border-radius:12px; background:#ffd166; color:#272400; font-size:15px;
    box-shadow: 0 6px 0 #caa644, 0 12px 24px rgba(0,0,0,.3);
    transition: transform .06s ease, box-shadow .06s ease, filter .06s ease;
  }
  .btn:hover{ filter:brightness(1.03); }
  .btn:active{ transform: translateY(2px); box-shadow: 0 4px 0 #caa644, 0 8px 16px rgba(0,0,0,.35); }

  /* 蠟燭 */
  .candle{
    position:absolute; width:60px; /* 依需求可調 */
    transform: translate(-50%, -100%); /* 以底部中央對齊座標 */
    pointer-events:auto; cursor:pointer;
    will-change: transform, opacity;
    transition: transform .08s ease;
  }
  .candle img{
    width:100%; height:auto; display:block; image-rendering:auto;
  }
  .candle.off .on{ display:none; }
  .candle.on  .off{ display:none; }
  .candle.flash{ animation: flash .15s linear 2; }
  @keyframes flash{ 0%,100%{ filter:none } 50%{ filter:brightness(1.35) } }

  /* 計時條（可視化難度加速感） */
  .timerbar{
    position:absolute; left:10px; right:10px; top:46px; height:6px; border-radius:999px;
    background: rgba(255,255,255,.15); overflow:hidden;
  }
  .timerbar > i{
    display:block; height:100%; width:100%; background:linear-gradient(90deg,#7ae582,#ffd166,#ef476f);
    transform-origin:left center;
    transform: scaleX(1);
    transition: transform .1s linear;
  }

  /* 響應式微調（手機較窄時字體縮小些） */
  @media (max-width: 640px){
    .badge{ font-size:12px; }
    .btn{ font-size:14px; }
  }
</style>
</head>
<body>
  <div class="game-wrap" id="game">
    <div class="stage" id="stage"></div>

    <div class="hud">
      <div class="badge" id="scoreLbl">分數：0</div>
      <div class="hearts" id="hearts"></div>
      <div class="badge" id="timeLbl">15.0s</div>
    </div>
    <div class="timerbar"><i id="timeBar"></i></div>

    <!-- 開始／結束遮罩 -->
    <div class="overlay" id="overlay">
      <div class="panel">
        <h2 class="title">Make a Wish</h2>
        <p class="subtitle">15 秒內點擊點燃的蠟燭！<br>前 7 秒一次 1 支，之後可能同時 2 支。</p>
        <button class="btn" id="startBtn">開始遊戲</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const wrap = document.getElementById('game');
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const scoreLbl = document.getElementById('scoreLbl');
  const timeLbl  = document.getElementById('timeLbl');
  const timeBar  = document.getElementById('timeBar');
  const heartsEl = document.getElementById('hearts');

  // 10 支蠟燭座標（以 800x600 的基準下設計），x,y 為像素
  // y 取蛋糕上緣附近，x 作自然分佈（可再微調）
  const candlePositions = [
    [120, 330],[190, 320],[260, 335],[330, 325],[400, 330],
    [470, 330],[540, 325],[610, 335],[680, 320],[750, 330]
  ];

  // 建立 10 支蠟燭 DOM（以底部中央錨點對齊 positions）
  const candles = candlePositions.map(([x,y], idx) => {
    const el = document.createElement('div');
    el.className = 'candle off';
    el.style.left = x + 'px';
    el.style.top  = y + 'px';
    el.dataset.index = idx;

    const off = document.createElement('img');
    off.src = './candle_off.png';
    off.alt = 'candle off';
    off.className = 'off';

    const on  = document.createElement('img');
    on.src = './candle_on.png';
    on.alt = 'candle on';
    on.className = 'on';

    el.appendChild(off);
    el.appendChild(on);
    document.getElementById('stage').appendChild(el);
    return {
      idx, el,
      state: 'idle',          // idle | lit
      expireTid: null         // 點燃逾時計時器
    }
  });

  // 遊戲狀態
  const MAX_LIFE = 5;
  const TOTAL_TIME = 15_000;   // 15s
  const LIT_DURATION = 1_000;  // 1s
  let life, score, startAt, ticking = false, timerId, spawnTid;

  // 初始化心數 UI
  function renderHearts(){
    heartsEl.innerHTML = '';
    for(let i=0;i<MAX_LIFE;i++){
      const h = document.createElement('i');
      h.className = 'heart' + (i < life ? '' : ' lost');
      heartsEl.appendChild(h);
    }
  }

  function reset(){
    life = MAX_LIFE;
    score = 0;
    startAt = null;
    ticking = false;
    scoreLbl.textContent = `分數：${score}`;
    timeLbl.textContent = (TOTAL_TIME/1000).toFixed(1) + 's';
    timeBar.style.transform = `scaleX(1)`;
    renderHearts();
    // 關掉所有計時器與狀態
    clearTimeout(spawnTid); clearInterval(timerId);
    candles.forEach(c => {
      c.state = 'idle';
      c.el.classList.remove('on','flash');
      c.el.classList.add('off');
      if (c.expireTid){ clearTimeout(c.expireTid); c.expireTid = null; }
    });
  }

  // 依經過時間計算下一次點燃間隔（線性縮短：1.2s -> 0.7s）
  function nextIntervalMs(elapsedMs){
    const t = Math.min(elapsedMs / TOTAL_TIME, 1); // 0~1
    const start = 1200, end = 700;
    return Math.round(start + (end - start) * t);
  }

  function litCount(){
    return candles.reduce((n,c)=> n + (c.state === 'lit' ? 1 : 0), 0);
  }

  // 取得目前允許的同時點燃上限
  function concurrentCap(elapsedMs){
    return (elapsedMs >= 7000) ? 2 : 1;
  }

  // 產生下一支點燃
  function spawnNext(){
    if(!ticking) return;
    const elapsed = performance.now() - startAt;

    // 若已達同時點燃上限，延後再試
    if (litCount() >= concurrentCap(elapsed)){
      spawnTid = setTimeout(spawnNext, 60);
      return;
    }

    // 挑一支可點燃的蠟燭
    const candidates = candles.filter(c => c.state === 'idle');
    if (candidates.length === 0){
      // 全在點燃或沒空位，就稍後再嘗試
      spawnTid = setTimeout(spawnNext, 60);
      return;
    }
    const chosen = candidates[Math.floor(Math.random() * candidates.length)];
    lightCandle(chosen);

    // 安排下一次點燃
    const interval = nextIntervalMs(elapsed);
    spawnTid = setTimeout(spawnNext, interval);
  }

  function lightCandle(c){
    c.state = 'lit';
    c.el.classList.remove('off'); c.el.classList.add('on','flash');
    // 逾時沒點到 -> 扣命
    c.expireTid = setTimeout(() => {
      if (c.state !== 'lit') return;
      c.state = 'idle';
      c.el.classList.remove('on','flash');
      c.el.classList.add('off');
      c.expireTid = null;
      loseLife();
    }, LIT_DURATION);
  }

  function snuffCandle(c){
    if (c.state !== 'lit') return;
    c.state = 'idle';
    c.el.classList.remove('on','flash');
    c.el.classList.add('off');
    if (c.expireTid) { clearTimeout(c.expireTid); c.expireTid = null; }
    score += 1;
    scoreLbl.textContent = `分數：${score}`;
  }

  function loseLife(){
    life = Math.max(0, life - 1);
    renderHearts();
    if (life <= 0){ return gameOver(); }
  }

  function bindClicks(){
    candles.forEach(c => {
      c.el.onclick = () => {
        snuffCandle(c);
      };
      // 行動裝置避免雙擊縮放
      c.el.addEventListener('touchstart', e => { e.preventDefault(); snuffCandle(c); }, {passive:false});
    });
  }

  function startGame(){
    reset();
    overlay.style.display = 'none';
    ticking = true;
    startAt = performance.now();

    // 主計時（每 100ms 更新時間/進度條）
    timerId = setInterval(() => {
      const elapsed = performance.now() - startAt;
      const remain = Math.max(0, TOTAL_TIME - elapsed);
      timeLbl.textContent = (remain/1000).toFixed(1) + 's';
      timeBar.style.transform = `scaleX(${remain / TOTAL_TIME})`;
      if (remain <= 0){ gameOver(); }
    }, 100);

    // 啟動點燃循環
    spawnTid = setTimeout(spawnNext, 600);
  }

  function gameOver(){
    if (!ticking) return;
    ticking = false;
    clearTimeout(spawnTid); clearInterval(timerId);
    // 關掉所有未結束的點燃
    candles.forEach(c => {
      if (c.expireTid){ clearTimeout(c.expireTid); c.expireTid = null; }
      c.state = 'idle';
      c.el.classList.remove('on','flash'); c.el.classList.add('off');
    });
    // 儲存最佳紀錄
    const best = Math.max(score, Number(localStorage.getItem('mw_best')||0));
    localStorage.setItem('mw_best', best);

    overlay.innerHTML = `
      <div class="panel">
        <h2 class="title">時間到！</h2>
        <p class="subtitle">本次分數：<b>${score}</b><br>最佳紀錄：<b>${best}</b></p>
        <button class="btn" id="restartBtn">再玩一次</button>
      </div>`;
    overlay.style.display = 'grid';
    document.getElementById('restartBtn').onclick = () => {
      overlay.innerHTML = `
        <div class="panel">
          <h2 class="title">Make a Wish</h2>
          <p class="subtitle">15 秒內點擊點燃的蠟燭！<br>前 7 秒一次 1 支，之後可能同時 2 支。</p>
          <button class="btn" id="startBtn">開始遊戲</button>
        </div>`;
      document.getElementById('startBtn').onclick = startGame;
    };
  }

  // 等比例縮放定位（當容器縮放時自動調整座標）
  const ro = new ResizeObserver(entries => {
    const rect = entries[0].contentRect;
    const scaleX = rect.width / 800;
    const scaleY = rect.height / 600;
    candles.forEach((c, i) => {
      const [x,y] = candlePositions[i];
      c.el.style.left = (x * scaleX) + 'px';
      c.el.style.top  = (y * scaleY) + 'px';
      c.el.style.width = (60 * scaleX) + 'px'; // 蠟燭寬跟著縮放
    });
  });
  ro.observe(wrap);

  // 綁定
  startBtn.onclick = startGame;
  bindClicks();
  reset();
})();
</script>
</body>
</html>
